.. _usage:

Usage
=====

.. _format:

Microscopy image format
-----------------------
The Foa3D tool accepts as input 3D RGB image stacks in TIF/TIFF or NumPy format.
Alternatively, a .yml stitch file generated by the ZetaStitcher tool for large volumetric stitching
[`ZetaStitcher GitHub <https://github.com/lens-biophotonics/ZetaStitcher>`_]
may be provided. This .yml file can be generated following the detailed documentation available at
[`ZetaStitcher Documentation <https://lens-biophotonics.github.io/ZetaStitcher/>`_]
from a collection of 3D stacks composing a tiled image reconstruction.
The .yml and the image stack files must be located within the same directory.
In detail, the Foa3D tool exploits the 3D alignment information included in the .yml file
in order to programmatically access and iteratively process
basic image sub-volumes, thus enabling the analysis of high-resolution microscopy reconstructions
of considerable extension.
The size (in MB) of these sub-volumes may be customized via the -m/--max-slice-size option:

.. code-block:: console

   $ python -m foa3d.py ../tpfm_mosaic/zetastitch.yml -m 200

Furthermore, the values (in μm) of the lateral and longitudinal pixel size should be specified,
along with the full width at half maximum of the optical system's point spread function:

.. code-block:: console

   $ ... --px-size-xy 0.4 --px-size-z 1 --psf-fwhm-x 1.5 --psf-fwhm-y 1.4 --psf-fwhm-z 3.1

This information is employed at the preprocessing stage of the pipeline to isotropize the image spatial resolution,
by blurring the coronal XY-plane of the sliced microscopy sub-volumes;
scanning and light-sheet fluorescence microscopes are indeed characterized by a poorer resolution
along the direction of the optical axis:
if not properly corrected, this anisotropy would then introduce a systematic bias
in the resulting 3D fiber orientation estimates. 

.. _frangi:

Frangi filter configuration
---------------------------
Fiber enhancement is achieved via a multiscale 3D Frangi filter [`Frangi, et al., 1998 <https://doi.org/10.1007/BFb0056195>`_].
The spatial scales of the filter (in μm) can be provided via the -s/--scales option.
As discussed in [Sorelli et al., 2022], the optimal scales which best preserve the original intensity
and cross-sectional size of the 3D tubular structures present in the analized images
correspond to half of their expected radius.
The Frangi filter is also characterized by three sensitivity parameters, α, β, and γ.
In detail, lower α values tend to amplify the response of the filter to the presence of elongated structures,
whereas an increase in β determines a relatively higher sensitivity to blob-shaped structures.
Usually, the α and β sensitivity parameters are heuristically fixed for the specific application
or image modality of interest:
the default values, namely α=0.001 and β=1, were shown to lead to a marked selective enhancement of
tubular fiber structures, and to a considerable rejection of the cell soma in two-photon fluorescence microscopy images.
Whereas α and β are linked to grey-level-invariant geometrical features,
the γ sensitivity is related to the image contrast:
if not specified by the user, this parameter is automatically set to half of the maximum Hessian norm computed
at each spatial scale of interest.
In the example below, the Frangi filter is tuned for fibers having a cross-sectional diameter of 5 and 10 μm,
with an automatic contrast sensitivity:

.. code-block:: console

   $ ... -a 0.001 --b 10 -s 1.25 2.5

.. _somamask:

Lipofuscin-based soma rejection
-------------------------------
A neuronal fluorescence channel may be optionally provided to the Foa3D tool,
in order to improve the specificity of the fiber orientation maps
achieved thanks to the inherent attenuation of non-tubular objects offered by the Frangi filter.
This is performed via a postprocessing step which further suppresses neuronal bodies
using Yen's automatic thresholding algorithm.
The enhanced neuronal body rejection may be activated via the -n/--neuron-mask option modifying,
if required, the default neuronal fluorescence channel:

.. code-block:: console

   $ ... -n --ch-fiber 0 --ch-neuron 1

.. _odf:

Orientation distribution functions
----------------------------------
High-resolution fiber orientation data obtained at the native pixel size of the imaging system can be integrated into 
orientation distribution functions (ODFs), providing a comprehensive statistical description
of 3D fiber tract orientations within larger spatial compartments or super-voxels.
ODFs are highly suitable for a multimodal quantitative comparison with spatial fiber architectures
mapped by other high-resolution optical modalities, as 3D-Polarized Light Imaging
[`Axer, et al., 2016 <https://doi.org/10.3389/fnana.2016.00040>`_].
Furthermore, the spatial downscaling produced by the ODF estimation allows to bridge the gulf between the meso-
and macro-scale connectomics that is generally targeted by diffusion magnetic resonance imaging (dMRI).
The Foa3D tool features the generation of fiber ODFs from the 3D orientation vector fields returned by
the Frangi filtering stage via the fast analytical approach described in
[`Alimi, et al., 2020 <https://doi.org/10.1016/j.media.2020.101760>`_].
Alimi's method is computationally efficient and is characterized by improved angular precision and resolution
with respect to deriving the ODFs by modeling local directional histograms of discretized fiber orientations.
The multiscale estimation of fiber ODFs may be enabled by specifying a list of super-voxel sides (in μm):

.. code-block:: console

   $ ... --odf-res 16 32 48

The Foa3D tool also provides the possibility to repeat the fiber ODFs estimation, skipping the Frangi filtering stage,
if a pre-estimated fiber orientation vector map is provided as input in place of the raw microscopy image volume:

.. code-block:: console

   $ python -m foa3d.py ../fiber_vec.h5 --odf-res 64

The fiber ODFs returned by the Foa3D tool may be accessed using the open source Mrtrix3 software package
for medical image processing and visualization
[`Tournier, et al., 2019 <https://doi.org/10.1016/j.neuroimage.2019.116137>`_].